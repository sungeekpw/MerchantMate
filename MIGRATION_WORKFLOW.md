# Bulletproof Database Migration Workflow

## Overview

This document defines the bulletproof database migration workflow that ensures proper development → test → production deployment of schema changes.

## Core Principles

1. **Schema changes must ALWAYS follow this flow**: Development → Test → Production
2. **No direct production changes** - All changes must be validated in test first
3. **Version-controlled migrations** - All schema changes are tracked and versioned
4. **Rollback capability** - Every migration can be undone if needed
5. **Environment isolation** - Each environment maintains its own migration history

## Migration Workflow Commands

### 1. Generate Migration (Development)
```bash
tsx scripts/migration-manager.ts generate
```
- Generates a new migration file based on current schema changes in development
- Creates timestamped migration file in `migrations/` directory
- Only run this after making changes to `shared/schema.ts`

### 2. Apply to Development
```bash
tsx scripts/migration-manager.ts apply dev
```
- Applies pending migrations to development database
- Creates backup before applying changes
- Updates migration history table

### 3. Apply to Test
```bash
tsx scripts/migration-manager.ts apply test
```
- Applies the same migrations to test database
- Must be run AFTER development application
- Creates backup before applying changes

### 4. Apply to Production
```bash
tsx scripts/migration-manager.ts apply prod
```
- Applies validated migrations to production
- Should only be run AFTER successful test validation
- Creates backup before applying changes
- Requires extra confirmation for safety

### 5. Check Migration Status
```bash
tsx scripts/migration-manager.ts status
```
- Shows which migrations have been applied to each environment
- Displays available migration files
- Helps identify environment sync issues

### 6. Validate Consistency
```bash
tsx scripts/migration-manager.ts validate
```
- Checks migration consistency across environments
- Identifies migrations ready for promotion
- Warns about any environment mismatches

## Proper Development Workflow

### Making Schema Changes

1. **Develop**: Make changes to `shared/schema.ts`
2. **Generate**: Run `tsx scripts/migration-manager.ts generate`
3. **Apply Dev**: Run `tsx scripts/migration-manager.ts apply dev`
4. **Test Locally**: Verify changes work in development
5. **Apply Test**: Run `tsx scripts/migration-manager.ts apply test`
6. **External Testing**: Validate changes in test environment
7. **Apply Prod**: After certification, run `tsx scripts/migration-manager.ts apply prod`

### Migration File Structure

```
migrations/
├── 20250818140001_add_user_columns.sql
├── 20250818150001_create_audit_table.sql
├── schema-backups/
│   ├── development-backup-2025-08-18T14-00-00.sql
│   ├── test-backup-2025-08-18T15-00-00.sql
│   └── production-backup-2025-08-18T16-00-00.sql
```

### Migration Tracking

Each environment maintains a `schema_migrations` table:
```sql
CREATE TABLE schema_migrations (
  id SERIAL PRIMARY KEY,
  migration_id VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  checksum VARCHAR(64) NOT NULL,
  environment VARCHAR(50) NOT NULL
);
```

## Safety Features

1. **Automatic Backups**: Every migration creates a backup first
2. **Transaction Safety**: Each migration runs in a transaction
3. **Checksum Verification**: Prevents corrupted migration files
4. **Environment Isolation**: Each environment tracks its own history
5. **Rollback Ready**: Backups enable quick rollback if needed

## Emergency Procedures

### If Migration Fails
1. Check the error message and logs
2. Review the migration SQL for issues
3. Use backup files to restore if needed
4. Fix the migration file and retry

### Environment Out of Sync
1. Run `tsx scripts/migration-manager.ts status` to see differences
2. Use `tsx scripts/migration-manager.ts validate` to identify issues
3. Apply missing migrations in correct order
4. Never skip environments in the workflow

## Best Practices

1. **Test Thoroughly**: Always test migrations in development first
2. **Small Changes**: Keep migrations small and focused
3. **Descriptive Names**: Use clear, descriptive migration names
4. **Review Changes**: Have schema changes reviewed before production
5. **Monitor Application**: Watch application logs after migrations
6. **Document Impact**: Note any application changes needed with migrations

## Integration with Existing System

- This workflow replaces the old `scripts/sync-database-schemas.ts` approach
- The new system provides proper version control and rollback capability
- Migration files are generated by Drizzle but managed by our workflow
- Environment switching still works through the login screen selector

## Troubleshooting

### Common Issues
- **Permission Errors**: Ensure database URLs are correctly configured
- **Connection Timeouts**: Check database connectivity
- **Migration Conflicts**: Resolve schema conflicts before generating migrations
- **Missing Dependencies**: Ensure all required packages are installed

### Getting Help
1. Run status command to see current state
2. Check migration files for syntax errors
3. Review database logs for detailed errors
4. Use backup files to restore if needed